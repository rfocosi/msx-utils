#!/bin/bash

SRC_FILE_PATH=$1

if [ -z "$SRC_FILE_PATH" ]; then
  echo "Usage: `basename $0` <source_file_path>.c"
  exit 1
fi

if [ ! -f "$SRC_FILE_PATH" ]; then
  echo "Not found $SRC_FILE_PATH"
  exit 1
fi

SRC_PATH=`dirname $SRC_FILE_PATH`
SRC_FILE=`basename $SRC_FILE_PATH`

cd $SRC_PATH

FILE_NAME=`echo $SRC_FILE | sed 's/\.c//g'`
SRC_FILE_PARAMS=`grep '^.\+' $FILE_NAME.params | head -n 1 | envsubst`
IHX_FILE=$FILE_NAME.ihx
COM_FILE=$FILE_NAME.com

[ ! -z "$EXTRA_SHARED_LIB" ] && [ ! -z "$( ls -1 $EXTRA_SHARED_LIB )" ] && cp $EXTRA_SHARED_LIB/* $SDCC_LIB_Z80/
[ ! -z "$EXTRA_SHARED_INCLUDE" ] && [ ! -z "$( ls -1 $EXTRA_SHARED_INCLUDE )" ] && cp $EXTRA_SHARED_INCLUDE/* $SDCC_INCLUDE_Z80/

echo "sdcc $SRC_FILE_PARAMS $SRC_FILE"
echo

sdcc $SRC_FILE_PARAMS $SRC_FILE

if [ -f "$IHX_FILE" ]; then
  hex2bin -e com $IHX_FILE

  BIN_PATH=$WORKSPACE_ROOT/build/

  [ ! -d $BIN_PATH ] && mkdir -p $BIN_PATH

  mv $COM_FILE $BIN_PATH

  echo
  echo "Final file: $BIN_PATH$COM_FILE"
fi

rm -f $FILE_NAME.rel $FILE_NAME.asm
rm -f *.ihx *.lk *.lst *.map *.noi *.sym
