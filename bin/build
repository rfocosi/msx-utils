#!/bin/bash

SRC_FILE_PATH=$1

if [ -z "$SRC_FILE_PATH" ]; then
  echo "Usage: `basename $0` <source_file_path>.c"
  exit 1
fi

if [ ! -f "$SRC_FILE_PATH" ]; then
  echo "Not found $SRC_FILE_PATH"
  exit 1
fi

SRC_PATH=`dirname $SRC_FILE_PATH`
SRC_FILE=`basename $SRC_FILE_PATH`

cd $SRC_PATH

FILE_NAME=`echo $SRC_FILE | sed 's/\.c//g'`
SRC_FILE_PARAMS=`grep '^.\+' $FILE_NAME.params | head -n 1 | envsubst`
IHX_FILE=$FILE_NAME.ihx
COM_FILE=$FILE_NAME.com

rm -f $COM_FILE

sdcc $SRC_FILE_PARAMS $SRC_FILE

if [ -f "$IHX_FILE" ]; then
  hex2bin -e com $IHX_FILE

  mkdir -p $WORKSPACE_ROOT/bin/

  mv $COM_FILE $WORKSPACE_ROOT/bin/
fi

rm -f $FILE_NAME.rel $FILE_NAME.asm
rm -f *.ihx *.lk *.lst *.map *.noi *.sym
